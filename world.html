<!-- world.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>World | SuperWorld</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      background-color: #1b1b1b;
      overflow: hidden;
    }
    #gameCanvas {
      image-rendering: pixelated;
      background: #333;
      display: block;
    }
    #ui {
      position: absolute;
      top: 10px;
      left: 10px;
      color: white;
      font-family: Arial, sans-serif;
      font-size: 1rem;
      background: rgba(0,0,0,0.4);
      padding: 10px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="640" height="360"></canvas>
  <div id="ui">Memuat world...</div>

  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCYLbIFVfaO487KN2z4ABDPTx1j0mBHF-o",
      authDomain: "superworld1.firebaseapp.com",
      databaseURL: "https://superworld1-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "superworld1",
      storageBucket: "superworld1.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const uid = localStorage.getItem("uid");
    if (!uid) window.location.href = "login.html";

    const canvas = document.getElementById("gameCanvas");
    const ctx = canvas.getContext("2d");
    const tileSize = 32;
    const worldSize = 20;

    const player = {
      x: 5,
      y: 5,
      frame: 1,
      direction: 1,
      image: new Image()
    };
    player.image.src = `asset/hero/Idle (1).png`;

    let world = [];
    let worldId = "default_world";

    // Load world from Firebase or create new
    db.ref("worlds/" + worldId).once("value").then(snapshot => {
      if (snapshot.exists()) {
        world = snapshot.val();
        document.getElementById("ui").textContent = "World dimuat.";
      } else {
        // create empty world
        for (let y = 0; y < worldSize; y++) {
          let row = [];
          for (let x = 0; x < worldSize; x++) {
            row.push(0); // 0 = kosong
          }
          world.push(row);
        }
        db.ref("worlds/" + worldId).set(world);
        document.getElementById("ui").textContent = "World baru dibuat.";
      }
      drawWorld();
    });

    // Draw loop
    function drawWorld() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let y = 0; y < worldSize; y++) {
        for (let x = 0; x < worldSize; x++) {
          if (world[y][x] === 1) {
            ctx.fillStyle = "#6c6";
            ctx.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
          }
        }
      }
      ctx.drawImage(player.image, player.x * tileSize, player.y * tileSize, tileSize, tileSize);
    }

    // Move player
    window.addEventListener("keydown", e => {
      if (e.key === "ArrowUp") player.y--;
      if (e.key === "ArrowDown") player.y++;
      if (e.key === "ArrowLeft") player.x--;
      if (e.key === "ArrowRight") player.x++;
      drawWorld();
    });

    // Idle animation loop
    setInterval(() => {
      player.frame = player.frame >= 10 ? 1 : player.frame + 1;
      player.image.src = `asset/hero/Idle (${player.frame}).png`;
      drawWorld();
    }, 200);
  </script>
</body>
</html>
